{% extends "layouts/main.html" %} {% block content %}
<div class="video-watch-container">
  <div class="video-player-container">
    {% if video.conversionStatus == 'processing' %}
    <div class="video-processing-message">
      <p>ë” ë§ì€ í™”ì§ˆ ì˜µì…˜ì´ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤. í˜„ì¬ ê°€ëŠ¥í•œ í™”ì§ˆë¡œ ì‹œì²­í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    </div>
    {% endif %}

    <video class="video-player" controls poster="{{ video.thumbnailUrl }}">
      <source
        src="{{ video.videoUrl }}"
        type="{% if video.selectedFormat %}video/webm{% else %}video/mp4{% endif %}"
      />
      ë¸Œë¼ìš°ì €ê°€ ë¹„ë””ì˜¤ íƒœê·¸ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
    </video>

    {% if video.formats and video.formats.length > 0 %}
    <div class="video-quality-selector">
      <span>í™”ì§ˆ: </span>
      <select id="quality-selector" onchange="changeVideoQuality(this.value)">
        {% for format in video.formats %}
        <option
          value="{{ format.filePath }}"
          {% if video.selectedFormat and video.selectedFormat.resolution == format.resolution %}selected{% endif %}
        >
          {{ format.resolution }} ({{ format.bitrate }})
        </option>
        {% endfor %}
      </select>
    </div>
    {% endif %}

    <div class="video-info">
      <h1 class="video-title">{{ video.title }}</h1>
      <div class="video-meta">
        <span>ì—…ë¡œë”: {{ video.user.nickname }}</span> â€¢
        <span>ì¡°íšŒìˆ˜: {{ video.viewCount }}</span> â€¢
        <span>ì—…ë¡œë“œ: {{ video.createdAt | date('YYYY-MM-DD') }}</span>
      </div>

      <div class="video-actions">
        {% if user %}
        <button
          class="retro-button like-button"
          hx-post="/video/{{ video.id }}/like"
          hx-swap="outerHTML"
          hx-trigger="click"
        >
          ğŸ‘ ì¢‹ì•„ìš” ({{ video.likeCount }})
        </button>

        {% if user.id === video.userId.toString() %}
        <a href="/video/{{ video.id }}/edit" class="retro-button edit-button">âœï¸ ìˆ˜ì •</a>
        <a href="/video/{{ video.id }}/delete" class="retro-button delete-button">ğŸ—‘ï¸ ì‚­ì œ</a>
        {% endif %}

        {% else %}
        <a href="/auth/login" class="retro-button">ë¡œê·¸ì¸í•˜ì—¬ ì¢‹ì•„ìš” ëˆ„ë¥´ê¸°</a>
        {% endif %}
      </div>

      {% if video.description %}
      <div class="video-description">
        <h3>ì„¤ëª…</h3>
        <p>{{ video.description }}</p>
      </div>
      {% endif %} {% if video.tags and video.tags.length > 0 %}
      <div class="video-tags">
        <h3>íƒœê·¸</h3>
        <div class="tag-list">
          {% for tag in video.tags %}
          <a href="/search?query={{ tag }}" class="tag">{{ tag }}</a>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </div>
  </div>

  <div class="comment-section">
    <h2>ëŒ“ê¸€ ({{ video.comments.length }})</h2>

    {% if user %}
    <div class="comment-form-container">
      <form
        hx-post="/video/{{ video.id }}/comment"
        hx-target="#comment-list"
        hx-swap="beforeend"
        class="comment-form retro-form"
      >
        <div class="form-group">
          <textarea
            name="content"
            placeholder="ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”..."
            class="form-textarea"
            required
          ></textarea>
        </div>
        <div class="form-actions">
          <button type="submit" class="form-button">ëŒ“ê¸€ ì‘ì„±</button>
        </div>
      </form>
    </div>
    {% else %}
    <div class="comment-login-prompt">
      <p><a href="/auth/login">ë¡œê·¸ì¸</a>í•˜ì—¬ ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”.</p>
    </div>
    {% endif %}

    <div id="comment-list" class="comment-list">
      {% for comment in video.comments %}
      <div class="comment-item">
        <div class="comment-meta">
          <span class="comment-author">{{ comment.authorName }}</span> â€¢
          <span class="comment-date">{{ comment.createdAt | date('YYYY-MM-DD HH:mm') }}</span>
        </div>
        <div class="comment-content">{{ comment.content }}</div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

<style>
  .video-processing-message {
    margin-bottom: 10px;
    padding: 8px 12px;
    background-color: #f0f0f0;
    border: 1px dashed #999;
    border-radius: 3px;
  }

  .video-processing-message p {
    margin: 0;
    font-size: 0.9em;
    color: #666;
  }
</style>

<script>
  function changeVideoQuality(filePath) {
    const video = document.querySelector('.video-player');
    const currentTime = video.currentTime;
    const isPaused = video.paused;

    // í˜„ì¬ source íƒœê·¸ ì‚­ì œ ë° ìƒˆë¡œìš´ íƒœê·¸ ìƒì„±
    while (video.firstChild) {
      video.removeChild(video.firstChild);
    }

    const source = document.createElement('source');
    source.src = `/api/video/stream?path=${encodeURIComponent(filePath)}`;
    source.type = 'video/webm';
    video.appendChild(source);

    // ë¡œë“œ í›„ ì´ì „ ì¬ìƒ ì‹œê°„ ë° ìƒíƒœ ë³µì›
    video.load();
    video.onloadedmetadata = function () {
      video.currentTime = currentTime;
      if (!isPaused) {
        video.play();
      }
    };
  }
</script>
{% endblock %}
